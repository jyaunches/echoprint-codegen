//
//  echoprint-codegen
//  Copyright 2011 The Echo Nest Corporation. All rights reserved.
//


#ifndef SUBBANDANALYSIS_H
#define SUBBANDANALYSIS_H
#include "Common.h"
#include "Params.h"
#include "MatrixUtility.h"

#define C_LEN 128
#define SUBBANDS 8
#define M_ROWS 8
#define M_COLS 16

namespace SubbandFilterBank {
    // 128pt, 1/8th band low-pass prototype subsampled from Table_analysis_window
    /*
    static const float C[C_LEN] = {
         0.000000477,  0.000000954,  0.000001431,  0.000002384,  0.000003815,  0.000006199,  0.000009060,  0.000013828,
         0.000019550,  0.000027657,  0.000037670,  0.000049591,  0.000062943,  0.000076771,  0.000090599,  0.000101566,
        -0.000108242, -0.000106812, -0.000095367, -0.000069618, -0.000027180,  0.000034332,  0.000116348,  0.000218868,
         0.000339031,  0.000472546,  0.000611782,  0.000747204,  0.000866413,  0.000954151,  0.000994205,  0.000971317,
        -0.000868797, -0.000674248, -0.000378609,  0.000021458,  0.000522137,  0.001111031,  0.001766682,  0.002457142,
         0.003141880,  0.003771782,  0.004290581,  0.004638195,  0.004752159,  0.004573822,  0.004049301,  0.003134727,
        -0.001800537, -0.000033379,  0.002161503,  0.004756451,  0.007703304,  0.010933399,  0.014358521,  0.017876148,
         0.021372318,  0.024725437,  0.027815342,  0.030526638,  0.032754898,  0.034412861,  0.035435200,  0.035780907,
        -0.035435200, -0.034412861, -0.032754898, -0.030526638, -0.027815342, -0.024725437, -0.021372318, -0.017876148,
        -0.014358521, -0.010933399, -0.007703304, -0.004756451, -0.002161503,  0.000033379,  0.001800537,  0.003134727,
        -0.004049301, -0.004573822, -0.004752159, -0.004638195, -0.004290581, -0.003771782, -0.003141880, -0.002457142,
        -0.001766682, -0.001111031, -0.000522137, -0.000021458,  0.000378609,  0.000674248,  0.000868797,  0.000971317,
        -0.000994205, -0.000954151, -0.000866413, -0.000747204, -0.000611782, -0.000472546, -0.000339031, -0.000218868,
        -0.000116348, -0.000034332,  0.000027180,  0.000069618,  0.000095367,  0.000106812,  0.000108242,  0.000101566,
        -0.000090599, -0.000076771, -0.000062943, -0.000049591, -0.000037670, -0.000027657, -0.000019550, -0.000013828,
        -0.000009060, -0.000006199, -0.000003815, -0.000002384, -0.000001431, -0.000000954, -0.000000477, 0};
}*/
    static const float C[C_LEN] = {
         0.000001478,  0.000002609,  0.000003647,  0.000005148,  0.000007059,  0.000009875,  0.000012861,  0.000017335,
         0.000021929,  0.000028284,  0.000036240,  0.000047147,  0.000061673,  0.000074991,  0.000097818,  0.000121219,
        -0.000085713, -0.000072546, -0.000053330, -0.000030532,  0.000008360,  0.000061326,  0.000128815,  0.000210608,
         0.000302737,  0.000404482,  0.000514191,  0.000635124,  0.000764095,  0.000849951,  0.000968999,  0.001041356,
        -0.000795822, -0.000526235, -0.000198697,  0.000135406,  0.000568514,  0.001051244,  0.001572264,  0.002117425,
         0.002658973,  0.003170417,  0.003616353,  0.003968740,  0.004176696,  0.004090657,  0.003878312,  0.003251333,
        -0.001707098,  0.000155488,  0.002198144,  0.004306753,  0.006748179,  0.009363660,  0.012072681,  0.014764151,
         0.017281362,  0.019574267,  0.021692904,  0.023916535,  0.026482213,  0.027860364,  0.031627282,  0.035562681,
        -0.035252690, -0.030677593, -0.026370111, -0.024534391, -0.021590345, -0.019081373, -0.016769138, -0.014374828,
        -0.011851674, -0.009243131, -0.006694281, -0.004297477, -0.002113626, -0.000329873,  0.001439366,  0.003012290,
        -0.004173808, -0.004311915, -0.004138588, -0.003993643, -0.003584691, -0.003109492, -0.002599185, -0.002064447,
        -0.001530723, -0.001017815, -0.000550716, -0.000137741,  0.000214719,  0.000462416,  0.000708125,  0.000899145,
        -0.001059537, -0.000919197, -0.000754888, -0.000645871, -0.000506098, -0.000386015, -0.000284531, -0.000196017,
        -0.000119370, -0.000054743, -0.000004148,  0.000033096,  0.000057861,  0.000068515,  0.000078428,  0.000083101,
        -0.000106194, -0.000081066, -0.000059572, -0.000047176, -0.000034556, -0.000025700, -0.000019558, -0.000015387,
        -0.000011508, -0.000008807, -0.000006199, -0.000004284, -0.000002850, -0.000001815, -0.000000773,  0.000000360};

class AudioStreamInput;

class SubbandAnalysis {
public:
    inline SubbandAnalysis() {};
    SubbandAnalysis(AudioStreamInput* pAudio);
    SubbandAnalysis(const float* pSamples, uint numSamples);
    virtual ~SubbandAnalysis();
    void Compute();
public:
    inline uint getNumFrames() const {return _NumFrames;}
    inline uint getNumSamples() const {return _NumSamples;}
    inline uint getNumBands() const {return SUBBANDS;}
    const matrix_f& getMatrix() {return _Data;}

protected:
    const float* _pSamples;
    uint _NumSamples;
    uint _NumFrames;
    matrix_f _Mi;
    matrix_f _Mr;
    matrix_f _Data;

private:
    void Init();
};

#endif
