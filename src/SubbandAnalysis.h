//
//  echoprint-codegen
//  Copyright 2011 The Echo Nest Corporation. All rights reserved.
//


#ifndef SUBBANDANALYSIS_H
#define SUBBANDANALYSIS_H
#include "Common.h"
#include "Params.h"
#include "MatrixUtility.h"

#define C_LEN 128
#define SUBBANDS 8
#define M_ROWS 8
#define M_COLS 16

namespace SubbandFilterBank {
    // 128pt, 1/8th band low-pass prototype subsampled from Table_analysis_window
    
    /*
    static const float C[C_LEN] = {
         0.000000477,  0.000000954,  0.000001431,  0.000002384,  0.000003815,  0.000006199,  0.000009060,  0.000013828,
         0.000019550,  0.000027657,  0.000037670,  0.000049591,  0.000062943,  0.000076771,  0.000090599,  0.000101566,
        -0.000108242, -0.000106812, -0.000095367, -0.000069618, -0.000027180,  0.000034332,  0.000116348,  0.000218868,
         0.000339031,  0.000472546,  0.000611782,  0.000747204,  0.000866413,  0.000954151,  0.000994205,  0.000971317,
        -0.000868797, -0.000674248, -0.000378609,  0.000021458,  0.000522137,  0.001111031,  0.001766682,  0.002457142,
         0.003141880,  0.003771782,  0.004290581,  0.004638195,  0.004752159,  0.004573822,  0.004049301,  0.003134727,
        -0.001800537, -0.000033379,  0.002161503,  0.004756451,  0.007703304,  0.010933399,  0.014358521,  0.017876148,
         0.021372318,  0.024725437,  0.027815342,  0.030526638,  0.032754898,  0.034412861,  0.035435200,  0.035780907,
        -0.035435200, -0.034412861, -0.032754898, -0.030526638, -0.027815342, -0.024725437, -0.021372318, -0.017876148,
        -0.014358521, -0.010933399, -0.007703304, -0.004756451, -0.002161503,  0.000033379,  0.001800537,  0.003134727,
        -0.004049301, -0.004573822, -0.004752159, -0.004638195, -0.004290581, -0.003771782, -0.003141880, -0.002457142,
        -0.001766682, -0.001111031, -0.000522137, -0.000021458,  0.000378609,  0.000674248,  0.000868797,  0.000971317,
        -0.000994205, -0.000954151, -0.000866413, -0.000747204, -0.000611782, -0.000472546, -0.000339031, -0.000218868,
        -0.000116348, -0.000034332,  0.000027180,  0.000069618,  0.000095367,  0.000106812,  0.000108242,  0.000101566,
        -0.000090599, -0.000076771, -0.000062943, -0.000049591, -0.000037670, -0.000027657, -0.000019550, -0.000013828,
        -0.000009060, -0.000006199, -0.000003815, -0.000002384, -0.000001431, -0.000000954, -0.000000477, 0};

    */
    static const float C[C_LEN] = {
     0.000001306, 0.000002456, 0.000003227, 0.000004709, 0.000006461, 0.000009393, 0.000012017, 0.000016484,
     0.000020196, 0.000026425, 0.000034635, 0.000049002, 0.000068503, 0.000057260, 0.000100396, 0.000146291,
     -0.000113045, -0.000080315, -0.000042124, -0.000043796, -0.000000914, 0.000056385, 0.000122856, 0.000202670,
     0.000287929, 0.000389009, 0.000504141, 0.000655042, 0.000822426, 0.000695336, 0.001001643, 0.001246393,
     -0.001053768, -0.000585972, -0.000085127, 0.000026981, 0.000503911, 0.001017289, 0.001535983, 0.002076754,
     0.002603625, 0.003124102, 0.003589000, 0.004005965, 0.004250666, 0.003618876, 0.003987165, 0.003683966,
     -0.002571265, -0.000046689, 0.002378092, 0.003823246, 0.006448844, 0.009208075, 0.011904159, 0.014514052,
     0.016813501, 0.019043862, 0.021368502, 0.024721819, 0.029020493, 0.022249553, 0.033012389, 0.044081922,
     -0.043873342, -0.032066336, -0.020802967, -0.027142915, -0.022428370, -0.018779413, -0.016265861, -0.013941145,
     -0.011643387, -0.009115709, -0.006570488, -0.004000186, -0.001598403, -0.000715541, 0.001677220, 0.004079034,
     -0.004934075, -0.004461459, -0.003512775, -0.004183194, -0.003658823, -0.003078497, -0.002545687, -0.002007276,
     -0.001496136, -0.000989230, -0.000524068, -0.000077861, 0.000317866, 0.000333528, 0.000767147, 0.001157469,
     -0.001290680, -0.000953839, -0.000594856, -0.000714290, -0.000529110, -0.000376349, -0.000269786, -0.000182578,
     -0.000113172, -0.000050422, -0.000000936, 0.000040688, 0.000068711, 0.000057311, 0.000084979, 0.000106700,
     -0.000130152, -0.000083311, -0.000043929, -0.000053891, -0.000036427, -0.000024305, -0.000018052, -0.000014055,
     -0.000010836, -0.000008265, -0.000005944, -0.000003822, -0.000002634, -0.000001571, -0.000000772, 0.000000395};
    
}

class AudioStreamInput;

class SubbandAnalysis {
public:
    inline SubbandAnalysis() {};
    SubbandAnalysis(AudioStreamInput* pAudio);
    SubbandAnalysis(const float* pSamples, uint numSamples);
    virtual ~SubbandAnalysis();
    void Compute();
public:
    inline uint getNumFrames() const {return _NumFrames;}
    inline uint getNumSamples() const {return _NumSamples;}
    inline uint getNumBands() const {return SUBBANDS;}
    const matrix_f& getMatrix() {return _Data;}

protected:
    const float* _pSamples;
    uint _NumSamples;
    uint _NumFrames;
    matrix_f _Mi;
    matrix_f _Mr;
    matrix_f _Data;

private:
    void Init();
};

#endif
